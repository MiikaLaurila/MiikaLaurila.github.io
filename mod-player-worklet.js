const PAULA_FREQUENCY=3546894.6,ARPEGGIO=0,SLIDE_UP=1,SLIDE_DOWN=2,TONE_PORTAMENTO=3,VIBRATO=4,TONE_PORTAMENTO_WITH_VOLUME_SLIDE=5,VIBRATO_WITH_VOLUME_SLIDE=6,SAMPLE_OFFSET=9,VOLUME_SLIDE=10,SET_VOLUME=12,PATTERN_BREAK=13,EXTENDED=14,SET_SPEED=15,RETRIGGER_NOTE=233,DELAY_NOTE=237,unimplementedEffects=new Set;class Channel{constructor(t){this.worklet=t,this.instrument=null,this.playing=!1,this.period=0,this.currentPeriod=0,this.portamentoSpeed=0,this.periodDelta=0,this.vibratoDepth=0,this.vibratoSpeed=0,this.vibratoIndex=0,this.arpeggio=!1,this.sampleSpeed=0,this.sampleIndex=0,this.volume=64,this.currentVolume=64}nextOutput(){if(!this.instrument||!this.period)return 0;const t=this.instrument.bytes[0|this.sampleIndex];if(this.sampleIndex+=this.sampleSpeed,this.instrument.isLooped)this.sampleIndex>=this.instrument.repeatOffset+this.instrument.repeatLength&&(this.sampleIndex=this.instrument.repeatOffset);else if(this.sampleIndex>=this.instrument.length)return 0;return t/256*this.currentVolume/64}performTick(){if(this.volumeSlide&&this.worklet.tick>0&&(this.currentVolume+=this.volumeSlide,this.currentVolume<0&&(this.currentVolume=0),this.currentVolume>64&&(this.currentVolume=64)),this.vibrato)this.vibratoIndex=(this.vibratoIndex+this.vibratoSpeed)%64,this.currentPeriod=this.period+Math.sin(this.vibratoIndex/64*Math.PI*2)*this.vibratoDepth;else if(this.periodDelta)if(this.portamento){if(this.currentPeriod!=this.period){const t=Math.sign(this.period-this.currentPeriod),e=Math.abs(this.currentPeriod-this.period),s=Math.min(e,this.periodDelta);this.currentPeriod+=t*s}}else this.currentPeriod+=this.periodDelta;else if(this.arpeggio){const t=this.worklet.tick%this.arpeggio.length,e=this.arpeggio[t];this.currentPeriod=this.period/Math.pow(2,e/12)}else this.retrigger&&this.worklet.tick%this.retrigger==0?this.sampleIndex=0:this.delayNote===this.worklet.tick&&(this.instrument=this.setInstrument,this.volume=this.setVolume,this.currentVolume=this.volume,this.period=this.setPeriod,this.currentPeriod=this.period,this.sampleIndex=0);this.currentPeriod<113&&(this.currentPeriod=113),this.currentPeriod>856&&(this.currentPeriod=856);const t=3546894.6/this.currentPeriod;this.sampleSpeed=t/this.worklet.sampleRate}play(t){if(this.setInstrument=!1,this.setVolume=!1,this.setPeriod=!1,this.delayNote=!1,t.instrument&&(this.setInstrument=this.worklet.mod.instruments[t.instrument],this.setVolume=this.setInstrument.volume),this.setSampleIndex=!1,this.setCurrentPeriod=!1,t.period){const e=this.setInstrument||this.instrument,s=e&&e.finetune||0;this.setPeriod=t.period-s,this.setCurrentPeriod=!0,this.setSampleIndex=0}this.effect(t),this.delayNote||(this.setInstrument&&(this.instrument=this.setInstrument),!1!==this.setVolume&&(this.volume=this.setVolume,this.currentVolume=this.volume),this.setPeriod&&(this.period=this.setPeriod),this.setCurrentPeriod&&(this.currentPeriod=this.period),!1!==this.setSampleIndex&&(this.sampleIndex=this.setSampleIndex))}effect({hasEffect:t,effectId:e,effectData:s,effectHigh:i,effectLow:r}){if(this.volumeSlide=0,this.periodDelta=0,this.portamento=!1,this.vibrato=!1,this.arpeggio=!1,this.retrigger=!1,this.delayNote=!1,t)switch(e){case 0:this.arpeggio=[0,i,r];break;case 1:this.periodDelta=-s;break;case 2:this.periodDelta=s;break;case 3:this.portamento=!0,s&&(this.portamentoSpeed=s),this.periodDelta=this.portamentoSpeed,this.setCurrentPeriod=!1,this.setSampleIndex=!1;break;case 4:i&&(this.vibratoSpeed=i),r&&(this.vibratoDepth=r),this.vibrato=!0;break;case 5:this.portamento=!0,this.setCurrentPeriod=!1,this.setSampleIndex=!1,this.periodDelta=this.portamentoSpeed,i?this.volumeSlide=i:r&&(this.volumeSlide=-r);break;case 6:this.vibrato=!0,i?this.volumeSlide=i:r&&(this.volumeSlide=-r);break;case 10:i?this.volumeSlide=i:r&&(this.volumeSlide=-r);break;case 9:this.setSampleIndex=256*s;break;case 12:this.setVolume=s;break;case 13:const t=10*i+r;this.worklet.setPatternBreak(t);break;case 15:s>=1&&s<=31?this.worklet.setTicksPerRow(s):this.worklet.setBpm(s);break;case 233:this.retrigger=s;break;case 237:this.delayNote=s;break;default:unimplementedEffects.has(e)||unimplementedEffects.add(e)}}}class ModPlayerWorklet extends AudioWorkletProcessor{constructor(){super(),this.port.onmessage=this.onmessage.bind(this),this.mod=null,this.channels=[new Channel(this),new Channel(this),new Channel(this),new Channel(this)],this.patternBreak=!1,this.publishRow=!1,this.publishStop=!1}onmessage(t){switch(t.data.type){case"play":this.play(t.data.mod,t.data.sampleRate);break;case"stop":this.stop();break;case"resume":this.resume();break;case"setRow":this.setRow(t.data.position,t.data.row);break;case"enableRowSubscription":this.publishRow=!0;break;case"disableRowSubscription":this.publishRow=!1;break;case"enableStopSubscription":this.publishStop=!0}}play(t,e){this.mod=t,this.sampleRate=e,this.setBpm(125),this.setTicksPerRow(6),this.position=-1,this.rowIndex=63,this.tick=5,this.ticksPerRow=6,this.outputsUntilNextTick=0,this.playing=!0}stop(){this.playing=!1}resume(){this.playing=!0}setRow(t,e){this.rowIndex=e-1,-1==this.rowIndex?(this.rowIndex=63,this.position=t-1):this.position=t,this.tick=this.ticksPerRow-1,this.outputsUntilNextTick=0,this.patternBreak=!1}setTicksPerRow(t){this.ticksPerRow=t}setBpm(t){this.bpm=t,this.outputsPerTick=60*this.sampleRate/this.bpm/4/6,0===t&&this.publishStop&&this.port.postMessage({type:"stop"})}setPatternBreak(t){this.patternBreak=t}nextRow(){if(++this.rowIndex,!1!==this.patternBreak?(this.rowIndex=this.patternBreak,++this.position,this.patternBreak=!1):64==this.rowIndex&&(this.rowIndex=0,++this.position),this.position>=this.mod.length)return this.stop(),void this.setBpm(0);const t=this.mod.patternTable[this.position],e=this.mod.patterns[t].rows[this.rowIndex];for(let t=0;t<4;++t)this.channels[t].play(e.notes[t]);this.publishRow&&this.port.postMessage({type:"row",position:this.position,rowIndex:this.rowIndex})}nextTick(){++this.tick,this.tick==this.ticksPerRow&&(this.tick=0,this.nextRow());for(let t=0;t<4;++t)this.channels[t].performTick()}nextOutput(){if(!this.mod)return 0;if(!this.playing)return 0;this.outputsUntilNextTick<=0&&(this.nextTick(),this.outputsUntilNextTick+=this.outputsPerTick),this.outputsUntilNextTick--;const t=this.channels.reduce(((t,e)=>t+e.nextOutput()),0);return Math.tanh(t)}process(t,e){const s=e[0][0];for(let t=0;t<s.length;++t){const e=this.nextOutput();s[t]=.5*e}return!0}}registerProcessor("mod-player-worklet",ModPlayerWorklet);